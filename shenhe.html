<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>审核页面</title>
    <style>
      li
      {
        background:orange;
        font-size:35px;
        margin-top: 5px;
      }
    </style>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="js/core.js">    </script>
    <script>
    $(function()
    {
      // WARNING: 需要添加网站管理员验证登录的功能，防止用户误触审核系统
      var php_path=set_php_path_mode("local")
      // NOTE: 获得待审核的数据
      get_to_check_data()
      function get_to_check_data()
      {
        $.get(php_path+"get_posted_juzi.php",function(data,status)
        {
          console.log(status)
          console.log("返回数据>"+data)
          console.log("返回数据类型"+typeof(data))
          var js_data=Array(data)
          console.log("array强制转换处理后数据类型"+typeof(js_data))
          console.log(js_data)
          var result=$.parseJSON(js_data)
          console.log("最终处理后>")
          console.log(result)
          // NOTE: 遍历 设置待审核的li的属性
          //$("#test").text(result[0].juzi+" "+"日期："+result[0].date+" "+"用户"+result[0].user)
          for(var i=0;i<result.length;i++)
          {
            console.log("执行了"+i+"次")
             // TODO: 根据json对象的长度，动态生成li
             $("#ol").append("<li class='t'></li>")
             $(".t:eq("+String(i)+")").text(result[i].juzi+"用户"+result[i].user)
             //+" "+"日期："+result[i].date+" "
             $(".t:eq("+String(i)+")").append("<button class='pass_btn'>可以通过</button><button class='faile_btn'>不可以通过</button>")
          }
          // NOTE: 两个审核按钮
        //  $(".pass_btn:eq(0)").click(function()
          $(".pass_btn").click(function()
          {
            // NOTE: 当通过按钮按下，设置状态为1，即通过审核
            var state=1
            $(this).css("background","green")
            // NOTE: 暂时遇到问题，需要一段时间来解决这个问题 使用echo函数解决？
            // TODO: 获取点击按钮所在li的文字 即button父节点
            //  var parent=$(".pass_btn").parent()
            var text_raw=$(this).parent().text()
            // NOTE: 需要处理掉按钮上的无用字符串
            alert(text_raw)
            var text=text_raw.split("用户")[0]
            // NOTE: 暂时还没有想到如何获取这个句子的用户信息，因为当按下按钮后，是通过this的parent节点来查找它对应的句子的
            var use=text_raw.split("用户")[1].split("可以通过")[0]
            console.log($(this).parent())
            console.log(text)
            console.log("用户"+use)
            // TODO: 提交post审核句子，参数1：句子 参数2：状态
            $.post(php_path+"shenhe.php",{juzi:text,status:state,user:use},function(data,status)
            {
              console.log(status)
              console.log("提交到shenhe.php并通过后，返回的数据"+data)
              //document.write(data)
              if(data)
              {
                alert("审核通过！已经添加这句话到句子总表")
              }
              else
              {
                alert("错误")
              }
            })
            // NOTE: 废弃方法
            //alert(parent.val())
            // NOTE: 为列表每个元素执行
            /*$(".t").each(function()
            {
              alert($(this).text())
            })*/
                      //  console.log(parent[0])
          //  console.log(parent[0].innerText)
          })
          $(".faile_btn").click(function()
          {
            // NOTE: 不通过 0
            var state=0
            var text_raw=$(this).parent().text()
            // NOTE: 需要处理掉按钮上的无用字符串
            alert(text_raw)
            var text=text_raw.split("用户")[0]
            // NOTE: 暂时还没有想到如何获取这个句子的用户信息，因为当按下按钮后，是通过this的parent节点来查找它对应的句子的
            var use=text_raw.split("用户")[1].split("可以通过")[0]
            console.log($(this).parent())
            console.log(text)
            console.log("用户"+use)
            $(this).css("background","red");
            $.post(php_path+"shenhe.php",{juzi:text,status:state,user:use},function(data,status)
            {
              console.log(status)
              console.log("提交到shenhe.php并通过后，返回的数据"+data)
              //document.write(data)
              if(data)
              {
            //    alert("审核通过！已经添加这句话到句子总表")
              }
              else
              {
                alert("错误")
              }
            })
            //alert("不可以通过")
          })
        })
      }

      // NOTE: 通过
      $("#pass_btn").click(function()
      {
        alert("pass")
        $("#pass_btn").css("background","green")
        // TODO: 从列表中删除通过的行
      })
      // NOTE: 不通过
      $("#faile_btn").click(function()
      {
        alert("failed")
        $("#faile_btn").css("background","red")
        // TODO: 从列表中设置不通过的行背景颜色为红色
      })
      // NOTE: 获取最新待审核的句子
      $("#get_latest_uncheckd_juzi").click(function()
      {
  //      get_to_check_data()
  // NOTE: 刷新
  location.reload()
      })
    })
    </script>
  </head>
  <body>
    <h1 align="center">每日一句审核系统v1 2020/12/19</h1>
    <center><button id="get_latest_uncheckd_juzi">手动获取最新待审核的句子</button></center>
    <h2>以下是待审核的句子</h2>
    <p>html动态插入li模板</p>
    <code>
      <xmp><li>string aaa</li><button id="pass_btn">可以通过</button><button id="faile_btn">不可以通过</button>
      </xmp>
</code>
    <div>
      <ol id="ol">
    <!--    <li class="t">string aaa<button id="pass_btn">可以通过</button><button id="faile_btn">不可以通过</button></li>
        <li class="t">string aaa<button id="pass">可以通过</button><button id="faile">不可以通过</button></li>
        <li class="t">NULL<button id="pass">可以通过</button><button id="faile">不可以通过</button></li>
        <li class="t">NULL<button id="pass">可以通过</button><button id="faile">不可以通过</button></li>
-->
      </ol>
      </div>
  </body>
</html>
